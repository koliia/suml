name: CI/CD Pipeline

# Run the workflow on every push to any branch
on:
  push:
    branches:
      - main
      - master

jobs:
  build_and_test:
    # FIX: Add permissions block to grant write access for pushing packages to GHCR.
    permissions:
      contents: read
      packages: write

    # Use a standard Ubuntu runner environment
    runs-on: ubuntu-latest

    # Define environment variables for the GHCR push step
    env:
      REGISTRY: ghcr.io
      IMAGE_NAME: ${{ github.repository }} # e.g., <owner>/iris-streamlit

    steps:
    - name: â¬‡ï¸ Checkout Repository
      # Checks out your repository under $GITHUB_WORKSPACE
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # ğŸ§ª Testing Phase
    # ----------------------------------------------------
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    - name: ğŸ“¦ Install dependencies
      # Install required packages including pytest
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest joblib

    - name: ğŸš€ Run tests with pytest
      # The PYTHONPATH issue is now handled by tests/conftest.py
      # We just run pytest as usual, instructing it where to find the tests.
      run: |
        pytest tests/test_app.py

    # ----------------------------------------------------
    # ğŸ³ Docker Build and Push Phase
    # ----------------------------------------------------
    - name: ğŸ”‘ Login to GitHub Container Registry (GHCR)
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        # Use GITHUB_TOKEN for authentication (it's automatically provided)
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸ Define image tags
      # Get the image tag based on the commit SHA and 'latest'
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          # The 'format=%.7s' was causing a parsing error. Reverting to the default 'type=sha'
          # which uses the full commit hash. This avoids the format parsing issue.
          type=sha
          type=raw,value=latest

    - name: ğŸ—ï¸ Build and Push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}